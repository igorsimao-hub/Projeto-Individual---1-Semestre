<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | PulpCine</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="./assets/icon/ICONE_TARANTINO.png">
    <link rel="stylesheet" href="./css/dashboardsIgor.css">
</head>
<body>
    <header>
        <nav>
            <h1>PulpCine | Quentin Tarantino</h1>
            <ul>
                <li><a href="./index.html">Início</a></li>
                <li><a href="./login.html">Login</a></li>
                <li><a href="./cadastro.html">Cadastro</a></li>
            </ul>
        </nav>
    </header>
    
    <section class="banner">
        <img class="imgBanner" src="./assets/imgs/Banner Dashboard.webp" alt="">
        <h2>Média geral dos filmes</h2>
        <p>Veja como os filmes de Tarantino estão sendo avaliados pelos usuários!</p>
    </section>
    <div class="filtro-filme" style="text-align:center; margin-bottom: 1.5rem;">
        <label for="selectFilme" style="color:#FFD700; font-weight:bold;">Escolha o filme:</label>
        <select id="selectFilme" style="padding:0.5rem; border-radius:6px; margin-left:0.5rem;">
            <!-- Opções serão preenchidas via JS -->
        </select>
    </div>


    
    <!-- Seção de KPIs -->
    <section class="kpis">
        <div class="card">
            <h3>Total de Avaliações</h3>
            <p id="kpiTotalAvaliacoes">-</p>
        </div>
        <div class="card">
            <h3>Média Geral</h3>
            <p id="kpiMediaGeral">-</p>
        </div>
        <div class="card">
            <h3>Filmes Avaliados</h3>
            <p id="kpiFilmesAvaliados">-</p>
        </div>
    </section>





    <section class="graficos">
        <h3>Média Geral dos Filmes</h3>
        <canvas id="graficoMedia" width="600" height="400"></canvas>

        <h3>Análise por Critério</h3>
        <div id="radarCharts" class="radar-grid"></div>
    </section>


    <footer>
        <p>© 2025 PulpCine - Todos os Direitos Reservados</p>
    </footer>

   <script>
    
    let filmesData = [];
    let avaliacoesData = [];

    function desenharGraficos() {
        // Gráfico de barras - Média Geral por Filme
        fetch('/avaliacao/mediaPorFilme')
            .then(res => res.json())
            .then(dados => {
                const filmes = dados.map(item => item.nome_filme);
                const medias = dados.map(item => Number(item.media_geral));
                const ctx = document.getElementById('graficoMedia').getContext('2d');

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: filmes,
                        datasets: [{
                            label: 'Média Geral',
                            data: medias,
                            backgroundColor: 'rgba(200, 30, 30, 0.7)',
                            borderColor: 'rgba(120, 0, 0, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                ticks: { color: '#fff' }
                            },
                            y: {
                                beginAtZero: true,
                                max: 10,
                                ticks: { color: '#fff' }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#fff' }
                            }
                        }
                    }
                });
            });

        // Gráficos Radar - Médias por Critério para cada Filme
        fetch('/avaliacao/mediasCriterioPorFilme')
            .then(res => res.json())
            .then(data => {
                const labels = ["Enredo", "Trilha Sonora", "Atuação", "Direção", "Fotografia"];
                const radarContainer = document.getElementById('radarCharts');
                radarContainer.innerHTML = '';  // Limpa antes de adicionar novos

                data.forEach(filme => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 300;
                    canvas.height = 300;
                    radarContainer.appendChild(canvas);

                    const ctx = canvas.getContext('2d');

                    new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: filme.nome_filme,
                                data: [
                                    filme.media_enredo,
                                    filme.media_trilha,
                                    filme.media_atuacao,
                                    filme.media_direcao,
                                    filme.media_foto
                                ],
                                fill: true,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgb(54, 162, 235)',
                                pointBackgroundColor: 'rgb(54, 162, 235)'
                            }]
                        },
                        options: {
                            scales: {
                                r: {
                                    pointLabels: { color: '#fff', font: { size: 14 } },
                                    angleLines: { color: '#888' },
                                    grid: { color: '#555' },
                                    ticks: { color: '#fff', backdropColor: 'transparent' }
                                }
                            },
                            plugins: {
                                legend: {
                                    labels: { color: '#fff' }
                                }
                            }
                        }
                    });
                });
            });
    }

    function preencherSelectFilmes() {
        const select = document.getElementById('selectFilme');
        select.innerHTML = '';

        filmesData.forEach(filme => {
            const option = document.createElement('option');
            option.value = filme.fk_filme
            option.textContent = filme.nome_filme;
            select.appendChild(option);
        });

        if (filmesData.length > 0) {
            atualizarKPIs(select.value);
        }
    }

    function atualizarKPIs(filmeId) {
       
        const filme = filmesData.find(f => f.fk_filme== filmeId);
        const avaliacoesFilme = avaliacoesData.filter(a => a.fk_filme == filmeId);

        kpiTotalAvaliacoes.innerHTML = avaliacoesFilme.length;
        document.getElementById('kpiMediaGeral').innerHTML = filme ? Number(filme.media_geral).toFixed(2) : '-';
        kpiFilmesAvaliados.innerHTML = filmesData.length
    }

    window.addEventListener('DOMContentLoaded', () => {
        Promise.all([
            fetch('/avaliacao/mediaPorFilme').then(res => res.json()),
            fetch('/avaliacao/todasAvaliacoes').then(res => res.json())
        ]).then(([filmes, avaliacoes]) => {
            filmesData = filmes;
            avaliacoesData = avaliacoes;

            preencherSelectFilmes();
            desenharGraficos();
        });

        document.getElementById('selectFilme').addEventListener('change', function () {
            atualizarKPIs(this.value);
        });
    });
</script>
